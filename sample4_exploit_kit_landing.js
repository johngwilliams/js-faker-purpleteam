/**
 * PURPLE TEAM TEST ARTIFACT - SAMPLE 4
 * Name: Exploit Kit Landing / Redirect Chain Simulation
 * Purpose: Tests detection of JS that performs environment profiling,
 *          plugin enumeration, conditional redirects, and iframe injection
 *          patterns typical of exploit kits (RIG, Angler, etc.)
 * Risk: NONE - No real exploits. No real redirects. All URLs point to localhost.
 * MITRE: T1189 (Drive-by Compromise), T1203 (Exploitation for Client Execution)
 * 
 * Expected detections:
 *   - Browser: Popup/redirect blocked, iframe sandbox violation
 *   - Proxy/SWG: Exploit kit pattern match, suspicious redirect chain
 *   - EDR: Browser spawning suspicious child processes (if any)
 *   - IDS/IPS: Known EK landing page signatures
 */

(function() {
    'use strict';

    // --- Gate: Environment fingerprinting (EK-style profiling) ---
    var _profile = {
        ua: (typeof navigator !== 'undefined') ? navigator.userAgent : 'unknown',
        platform: (typeof navigator !== 'undefined') ? navigator.platform : 'unknown',
        plugins: [],
        flash: false,
        java: false,
        silverlight: false,
        pdf_reader: false,
        screen_res: 'unknown',
        color_depth: 0,
        cookie_enabled: false,
        do_not_track: false,
        webgl_vendor: 'unknown',
        canvas_hash: 'not_computed'
    };

    // Plugin enumeration (classic EK fingerprinting)
    if (typeof navigator !== 'undefined' && navigator.plugins) {
        for (var i = 0; i < Math.min(navigator.plugins.length, 20); i++) {
            var p = navigator.plugins[i];
            _profile.plugins.push(p.name);

            var name_lower = p.name.toLowerCase();
            if (name_lower.indexOf('flash') !== -1) _profile.flash = true;
            if (name_lower.indexOf('java') !== -1) _profile.java = true;
            if (name_lower.indexOf('silverlight') !== -1) _profile.silverlight = true;
            if (name_lower.indexOf('pdf') !== -1 || name_lower.indexOf('acrobat') !== -1) _profile.pdf_reader = true;
        }
    }

    // Screen and display profiling
    if (typeof screen !== 'undefined') {
        _profile.screen_res = screen.width + 'x' + screen.height;
        _profile.color_depth = screen.colorDepth;
    }

    // Cookie check
    _profile.cookie_enabled = (typeof navigator !== 'undefined') ? navigator.cookieEnabled : false;

    // DNT check
    if (typeof navigator !== 'undefined') {
        _profile.do_not_track = navigator.doNotTrack === '1' || navigator.doNotTrack === 'yes';
    }

    // WebGL vendor (used for VM/sandbox detection)
    try {
        if (typeof document !== 'undefined') {
            var canvas = document.createElement('canvas');
            var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (gl) {
                var debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                if (debugInfo) {
                    _profile.webgl_vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                }
            }
        }
    } catch(e) {}

    // --- Anti-analysis / VM detection patterns (benign checks) ---
    var _is_vm = false;
    var _is_debugger = false;

    // Check for common VM indicators in WebGL renderer
    var vm_indicators = ['vmware', 'virtualbox', 'parallels', 'qemu', 'xen', 'hyper-v', 'swiftshader'];
    for (var v = 0; v < vm_indicators.length; v++) {
        if (_profile.webgl_vendor.toLowerCase().indexOf(vm_indicators[v]) !== -1) {
            _is_vm = true;
            break;
        }
    }

    // Screen size heuristic (very small = possible automated browser)
    if (typeof screen !== 'undefined' && (screen.width < 800 || screen.height < 600)) {
        _is_vm = true;
    }

    // Debugger detection pattern (real EKs use this to evade analysis)
    var _debug_start = performance.now();
    // debugger; // Uncomment to test debugger-detection evasion — left commented for safety
    var _debug_elapsed = performance.now() - _debug_start;
    if (_debug_elapsed > 100) {
        _is_debugger = true;
    }

    console.log('[PURPLE TEAM] Environment profile: ' + JSON.stringify(_profile, null, 2));
    console.log('[PURPLE TEAM] VM detected: ' + _is_vm);
    console.log('[PURPLE TEAM] Debugger detected: ' + _is_debugger);

    // --- Simulated conditional redirect chain ---
    // Real EKs redirect based on the profile. We just log what WOULD happen.
    var _redirect_target = 'http://127.0.0.1:65535/exploit-gate';
    var _payload_url = 'http://127.0.0.1:65535/payload.exe';

    if (!_is_vm && !_is_debugger) {
        console.log('[PURPLE TEAM] Profile passes gate check. In a real EK, user would be redirected to: ' + _redirect_target);

        // Simulated iframe injection (NOT actually injected into DOM)
        if (typeof document !== 'undefined') {
            var _exploit_iframe = document.createElement('iframe');
            _exploit_iframe.src = _redirect_target;
            _exploit_iframe.style.width = '1px';
            _exploit_iframe.style.height = '1px';
            _exploit_iframe.style.border = 'none';
            _exploit_iframe.style.position = 'absolute';
            _exploit_iframe.style.left = '-9999px';
            // NOT appended: document.body.appendChild(_exploit_iframe);
            console.log('[PURPLE TEAM] Hidden iframe CREATED but NOT injected into DOM.');
        }

        // Simulated payload download trigger (NOT actually triggered)
        console.log('[PURPLE TEAM] In a real EK, payload would download from: ' + _payload_url);

    } else {
        console.log('[PURPLE TEAM] VM or debugger detected. Real EK would abort. No redirect.');
    }

    // --- Simulated "malvertising" redirect via meta refresh pattern ---
    if (typeof document !== 'undefined') {
        var _meta = document.createElement('meta');
        _meta.httpEquiv = 'refresh';
        _meta.content = '9999;url=http://127.0.0.1:65535/malvert-landing';
        // NOT appended — just demonstrates the pattern
        console.log('[PURPLE TEAM] Meta refresh element created but NOT injected.');
    }

    // --- Simulated window.open popup (common in social engineering kits) ---
    // NOT actually called — just constructed
    var _popup_url = 'http://127.0.0.1:65535/fake-update-prompt';
    console.log('[PURPLE TEAM] Popup URL prepared (NOT opened): ' + _popup_url);

    console.log('[PURPLE TEAM] Sample 4 complete. No real exploits, redirects, or downloads occurred.');

})();
